name: Build golang base image

on:
  workflow_dispatch:
  workflow_call:
  # pull_request:
  # push:
  #   branches:
  #     - 'master'

jobs:
  build-docker-image:
    env:
      Registry: europe-west1-docker.pkg.dev/triple-management/triple
      Image: golang
      BaseTag: 1.24.6
    runs-on: ubuntu-latest
    steps:
      - name: Display Contexts
        run: | 
          echo "GitHub SHA github.sha: ${{ github.sha }}"
          echo "GitHub Ref Name github.ref_name: ${{ github.ref_name }}"
          echo "GitHub Event Pull Reqeust Head github.event.pull_request.head.sha: ${{ github.event.pull_request.head.sha }}"
          # only available when the event that triggers a workflow run is either pull_request or pull_request_target.
          echo "GitHub Base Ref (pr target branch) github.base_ref: ${{ github.base_ref }}"
          echo "GitHub Base Ref (pr target branch) github.ref_name: ${{ github.ref_name }}"
          echo "GitHub Head Ref (source branch) github.head_ref: ${{ github.head_ref }}"
          echo ""
          echo "GIT_COMMIT=${{ github.event.pull_request.head.sha || github.sha }}"
          echo "When merging to master the GIT_COMMIT should be equal to github.sha"
          echo ""
          echo "Adding whitespace commit for feat/my-feature-02 branch"

      - uses: actions/checkout@v4
        timeout-minutes: 1
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Docker Buildx
        timeout-minutes: 1
        uses: docker/setup-buildx-action@v3
      
      - name: Set up Docker Buildx
        timeout-minutes: 1
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DEV_DOCKERHUB_USER }}
          password: ${{ secrets.DEV_DOCKERHUB_PAT }}

      - name: Push prod image
        timeout-minutes: 15
        uses: docker/build-push-action@v5
        with:
          context: images/golang/1.24.6
          push: true
          # temp workaround for newer buildx where images outputed by default are not cloud run compatible https://github.com/docker/buildx/issues/1533
          provenance: false
          build-args: GIT_COMMIT=${{ github.event.pull_request.head.sha || github.sha }}
          tags: |
            ${{ env.Registry }}/${{ env.Image }}:${{ env.BaseTag }}-${{ github.sha }}
